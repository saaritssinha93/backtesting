param(
    [Parameter(Mandatory = $true)]
    [string]$CloudflaredPath,

    [Parameter(Mandatory = $true)]
    [string]$DashUrl,

    [Parameter(Mandatory = $true)]
    [string]$LogFile,

    [Parameter(Mandatory = $true)]
    [string]$LatestUrlFile,

    [Parameter(Mandatory = $true)]
    [string]$WaLinkFile,

    [string]$WhatsappTo = "",

    [switch]$OpenWhatsappLink
)

$ErrorActionPreference = "Continue"

try {
    $logDir = Split-Path -Parent $LogFile
    if ($logDir -and -not (Test-Path -LiteralPath $logDir)) {
        New-Item -Path $logDir -ItemType Directory -Force | Out-Null
    }

    $waToDigits = ($WhatsappTo -replace "[^0-9]", "")
    $announced = $false

    & $CloudflaredPath tunnel --url $DashUrl --protocol http2 --edge-ip-version 4 2>&1 | ForEach-Object {
        $line = $_.ToString()
        Write-Output $line
        Add-Content -Path $LogFile -Value $line -Encoding utf8

        if (-not $announced -and $line -match "https://[a-z0-9-]+\.trycloudflare\.com") {
            $url = $Matches[0]
            Set-Content -Path $LatestUrlFile -Value $url -Encoding utf8

            $msg = "[INFO] Public URL saved: $url"
            Write-Output $msg
            Add-Content -Path $LogFile -Value $msg -Encoding utf8

            if ($waToDigits) {
                $waText = [uri]::EscapeDataString("EQIDV2 dashboard: $url")
                $waLink = "https://wa.me/${waToDigits}?text=$waText"
                Set-Content -Path $WaLinkFile -Value $waLink -Encoding utf8

                $waMsg = "[INFO] WhatsApp share link saved: $waLink"
                Write-Output $waMsg
                Add-Content -Path $LogFile -Value $waMsg -Encoding utf8

                if ($OpenWhatsappLink) {
                    try { Start-Process $waLink | Out-Null } catch {}
                }
            }

            try { Set-Clipboard -Value $url } catch {}
            $announced = $true
        }
    }

    exit $LASTEXITCODE
}
catch {
    $err = "[ERROR] run_log_dashboard_public_link_capture.ps1 failed: $($_.Exception.Message)"
    Write-Output $err
    try { Add-Content -Path $LogFile -Value $err -Encoding utf8 } catch {}
    exit 1
}
