param(
    [Parameter(Mandatory = $true)]
    [string]$CloudflaredPath,

    [Parameter(Mandatory = $true)]
    [string]$DashUrl,

    [Parameter(Mandatory = $true)]
    [string]$LogFile,

    [Parameter(Mandatory = $true)]
    [string]$LatestUrlFile,

    [Parameter(Mandatory = $true)]
    [string]$WaLinkFile,

    [string]$WhatsappTo = "",

    [switch]$OpenWhatsappLink,

    [switch]$AutoSendWhatsapp
)

$ErrorActionPreference = "Continue"

try {
    $logDir = Split-Path -Parent $LogFile
    if ($logDir -and -not (Test-Path -LiteralPath $logDir)) {
        New-Item -Path $logDir -ItemType Directory -Force | Out-Null
    }

    $waToDigits = ($WhatsappTo -replace "[^0-9]", "")
    $announced = $false

    & $CloudflaredPath tunnel --url $DashUrl --protocol http2 --edge-ip-version 4 2>&1 | ForEach-Object {
        $line = $_.ToString()
        Write-Output $line
        Add-Content -Path $LogFile -Value $line -Encoding utf8

        if (-not $announced -and $line -match "https://[a-z0-9-]+\.trycloudflare\.com") {
            $url = $Matches[0]
            Set-Content -Path $LatestUrlFile -Value $url -Encoding utf8

            $msg = "[INFO] Public URL saved: $url"
            Write-Output $msg
            Add-Content -Path $LogFile -Value $msg -Encoding utf8

            if ($waToDigits) {
                $waText = [uri]::EscapeDataString("EQIDV2 dashboard: $url")
                $waLink = "https://wa.me/${waToDigits}?text=$waText"
                Set-Content -Path $WaLinkFile -Value $waLink -Encoding utf8

                $waMsg = "[INFO] WhatsApp share link saved: $waLink"
                Write-Output $waMsg
                Add-Content -Path $LogFile -Value $waMsg -Encoding utf8

                if ($OpenWhatsappLink -or $AutoSendWhatsapp) {
                    $opened = $false
                    $deepLink = "whatsapp://send?phone=$waToDigits&text=$waText"
                    try {
                        Start-Process $deepLink | Out-Null
                        $opened = $true
                        $openMsg = "[INFO] WhatsApp deep link opened."
                        Write-Output $openMsg
                        Add-Content -Path $LogFile -Value $openMsg -Encoding utf8
                    }
                    catch {
                        try {
                            Start-Process $waLink | Out-Null
                            $opened = $true
                            $openMsg = "[INFO] WhatsApp web link opened."
                            Write-Output $openMsg
                            Add-Content -Path $LogFile -Value $openMsg -Encoding utf8
                        }
                        catch {}
                    }

                    if ($AutoSendWhatsapp -and $opened) {
                        $sent = $false
                        try {
                            Start-Sleep -Seconds 8
                            $ws = New-Object -ComObject WScript.Shell
                            for ($i = 1; $i -le 10 -and -not $sent; $i++) {
                                foreach ($title in @("WhatsApp", "Google Chrome", "Microsoft Edge", "Chrome", "Edge")) {
                                    if ($ws.AppActivate($title)) {
                                        Start-Sleep -Milliseconds 700
                                        $ws.SendKeys("{ENTER}")
                                        Start-Sleep -Milliseconds 700
                                        $ws.SendKeys("{ENTER}")
                                        $sent = $true
                                        break
                                    }
                                }
                                if (-not $sent) { Start-Sleep -Seconds 1 }
                            }
                        }
                        catch {}

                        if ($sent) {
                            $sendMsg = "[INFO] WhatsApp auto-send keystroke attempted (ENTER x2)."
                            Write-Output $sendMsg
                            Add-Content -Path $LogFile -Value $sendMsg -Encoding utf8
                        }
                        else {
                            $warnMsg = "[WARN] WhatsApp auto-send could not activate app/window."
                            Write-Output $warnMsg
                            Add-Content -Path $LogFile -Value $warnMsg -Encoding utf8
                        }
                    }
                }
            }

            try { Set-Clipboard -Value $url } catch {}
            $announced = $true
        }
    }

    exit $LASTEXITCODE
}
catch {
    $err = "[ERROR] run_log_dashboard_public_link_capture.ps1 failed: $($_.Exception.Message)"
    Write-Output $err
    try { Add-Content -Path $LogFile -Value $err -Encoding utf8 } catch {}
    exit 1
}
